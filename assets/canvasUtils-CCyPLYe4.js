import{D as e,C as t,g as a}from"./index-DUlUeSx3.js";let i;function n(t){const a=e.get().createCanvas(6,1),i=a.getContext("2d");return i.fillStyle=t,i.fillRect(0,0,6,1),a}function r(){if(void 0!==i)return i;try{const t=n("#ff00ff"),a=n("#ffff00"),r=e.get().createCanvas(6,1).getContext("2d");r.globalCompositeOperation="multiply",r.drawImage(t,0,0),r.drawImage(a,2,0);const o=r.getImageData(2,0,1,1);if(o){const e=o.data;i=255===e[0]&&0===e[1]&&0===e[2]}else i=!1}catch(t){i=!1}return i}const o={canvas:null,convertTintToImage:!1,cacheStepsPerColorChannel:8,canUseMultiply:r(),tintMethod:null,_canvasSourceCache:new WeakMap,_unpremultipliedCache:new WeakMap,getCanvasSource:t=>{const a=t.source,i=a?.resource;if(!i)return null;const n="premultiplied-alpha"===a.alphaMode,r=a.resourceWidth??a.pixelWidth,s=a.resourceHeight??a.pixelHeight,c=r!==a.pixelWidth||s!==a.pixelHeight;if(n){if((i instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&i instanceof OffscreenCanvas)&&!c)return i;const e=o._unpremultipliedCache.get(a);if(e?.resourceId===a._resourceId)return e.canvas}if(i instanceof Uint8Array||i instanceof Uint8ClampedArray||i instanceof Int8Array||i instanceof Uint16Array||i instanceof Int16Array||i instanceof Uint32Array||i instanceof Int32Array||i instanceof Float32Array||i instanceof ArrayBuffer){const t=o._canvasSourceCache.get(a);if(t?.resourceId===a._resourceId)return t.canvas;const n=e.get().createCanvas(a.pixelWidth,a.pixelHeight),r=n.getContext("2d"),s=r.createImageData(a.pixelWidth,a.pixelHeight),c=s.data,h=i instanceof ArrayBuffer?new Uint8Array(i):new Uint8Array(i.buffer,i.byteOffset,i.byteLength);if("bgra8unorm"===a.format)for(let e=0;e<c.length&&e+3<h.length;e+=4)c[e]=h[e+2],c[e+1]=h[e+1],c[e+2]=h[e],c[e+3]=h[e+3];else c.set(h.subarray(0,c.length));return r.putImageData(s,0,0),o._canvasSourceCache.set(a,{canvas:n,resourceId:a._resourceId}),n}if(n){const t=e.get().createCanvas(a.pixelWidth,a.pixelHeight),n=t.getContext("2d",{willReadFrequently:!0});t.width=a.pixelWidth,t.height=a.pixelHeight,n.drawImage(i,0,0);const r=n.getImageData(0,0,t.width,t.height),s=r.data;for(let e=0;e<s.length;e+=4){const t=s[e+3];if(t>0){const a=255/t;s[e]=Math.min(255,s[e]*a+.5),s[e+1]=Math.min(255,s[e+1]*a+.5),s[e+2]=Math.min(255,s[e+2]*a+.5)}}return n.putImageData(r,0,0),o._unpremultipliedCache.set(a,{canvas:t,resourceId:a._resourceId}),t}if(c){const t=o._canvasSourceCache.get(a);if(t?.resourceId===a._resourceId)return t.canvas;const n=e.get().createCanvas(a.pixelWidth,a.pixelHeight),r=n.getContext("2d");return n.width=a.pixelWidth,n.height=a.pixelHeight,r.drawImage(i,0,0),o._canvasSourceCache.set(a,{canvas:n,resourceId:a._resourceId}),n}return i},getTintedCanvas:(a,i)=>{const n=a.texture,r=t.shared.setValue(i).toHex(),s=n.tintCache||(n.tintCache={}),c=s[r],h=n.source._resourceId;if(c?.tintId===h)return c;const l=c&&"getContext"in c?c:e.get().createCanvas();return o.tintMethod(n,i,l),l.tintId=h,s[r]=l,s[r]},getTintedPattern:(a,i)=>{const n=t.shared.setValue(i).toHex(),r=a.patternCache||(a.patternCache={}),s=a.source._resourceId;let c=r[n];if(c?.tintId===s)return c;o.canvas||(o.canvas=e.get().createCanvas()),o.tintMethod(a,i,o.canvas);return c=o.canvas.getContext("2d").createPattern(o.canvas,"repeat"),c.tintId=s,r[n]=c,c},applyPatternTransform:(e,t,a=!0)=>{if(!t)return;const i=e;if(!i.setTransform)return;const n=globalThis.DOMMatrix;if(!n)return;const r=new n([t.a,t.b,t.c,t.d,t.tx,t.ty]);i.setTransform(a?r.inverse():r)},tintWithMultiply:(e,i,n)=>{const r=n.getContext("2d"),s=e.frame.clone(),c=e.source._resolution??e.source.resolution??1,h=e.rotate;s.x*=c,s.y*=c,s.width*=c,s.height*=c;const l=a.isVertical(h),d=l?s.height:s.width,u=l?s.width:s.height;n.width=Math.ceil(d),n.height=Math.ceil(u),r.save(),r.fillStyle=t.shared.setValue(i).toHex(),r.fillRect(0,0,d,u),r.globalCompositeOperation="multiply";const g=o.getCanvasSource(e);g?(h&&o._applyInverseRotation(r,h,s.width,s.height),r.drawImage(g,s.x,s.y,s.width,s.height,0,0,s.width,s.height),r.globalCompositeOperation="destination-atop",r.drawImage(g,s.x,s.y,s.width,s.height,0,0,s.width,s.height),r.restore()):r.restore()},tintWithOverlay:(e,i,n)=>{const r=n.getContext("2d"),s=e.frame.clone(),c=e.source._resolution??e.source.resolution??1,h=e.rotate;s.x*=c,s.y*=c,s.width*=c,s.height*=c;const l=a.isVertical(h),d=l?s.height:s.width,u=l?s.width:s.height;n.width=Math.ceil(d),n.height=Math.ceil(u),r.save(),r.globalCompositeOperation="copy",r.fillStyle=t.shared.setValue(i).toHex(),r.fillRect(0,0,d,u),r.globalCompositeOperation="destination-atop";const g=o.getCanvasSource(e);g?(h&&o._applyInverseRotation(r,h,s.width,s.height),r.drawImage(g,s.x,s.y,s.width,s.height,0,0,s.width,s.height),r.restore()):r.restore()},tintWithPerPixel:(e,t,i)=>{const n=i.getContext("2d"),r=e.frame.clone(),s=e.source._resolution??e.source.resolution??1,c=e.rotate;r.x*=s,r.y*=s,r.width*=s,r.height*=s;const h=a.isVertical(c),l=h?r.height:r.width,d=h?r.width:r.height;i.width=Math.ceil(l),i.height=Math.ceil(d),n.save(),n.globalCompositeOperation="copy";const u=o.getCanvasSource(e);if(!u)return void n.restore();c&&o._applyInverseRotation(n,c,r.width,r.height),n.drawImage(u,r.x,r.y,r.width,r.height,0,0,r.width,r.height),n.restore();const g=t>>16&255,f=t>>8&255,p=255&t,v=n.getImageData(0,0,l,d),C=v.data;for(let a=0;a<C.length;a+=4)C[a]=C[a]*g/255,C[a+1]=C[a+1]*f/255,C[a+2]=C[a+2]*p/255;n.putImageData(v,0,0)},_applyInverseRotation:(e,t,i,n)=>{const r=a.inv(t),o=a.uX(r),s=a.uY(r),c=a.vX(r),h=a.vY(r),l=-Math.min(0,o*i,c*n,o*i+c*n),d=-Math.min(0,s*i,h*n,s*i+h*n);e.transform(o,s,c,h,l,d)}};o.tintMethod=o.canUseMultiply?o.tintWithMultiply:o.tintWithPerPixel;export{r as a,o as c};
